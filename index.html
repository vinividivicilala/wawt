async function loadUsers(searchTerm = "") {
    const usersListEl = document.getElementById('usersList');
    if (!usersListEl) return;

    usersListEl.innerHTML = `
        <div class="users-loader">
            <div class="loader"></div>
            <p>Memuat daftar pengguna...</p>
        </div>
    `;

    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            usersListEl.innerHTML = `<div class="no-users-found"><p>Silakan login untuk melihat pengguna lain</p></div>`;
            return;
        }

        const searchLower = searchTerm.trim().toLowerCase();
        let usersMap = new Map(); // untuk menghindari duplikat

        if (searchLower) {
            // 1️⃣ Cari berdasarkan displayName
            const nameQuery = query(
                collection(db, 'users'),
                orderBy('displayNameLower'), // simpan field lowercase di Firestore
                startAt(searchLower),
                endAt(searchLower + '\uf8ff')
            );
            const nameSnap = await getDocs(nameQuery);
            nameSnap.forEach(docSnap => {
                const user = docSnap.data();
                if (user.uid !== currentUser.uid) {
                    usersMap.set(user.uid, user);
                }
            });

            // 2️⃣ Cari berdasarkan email
            const emailQuery = query(
                collection(db, 'users'),
                orderBy('emailLower'),
                startAt(searchLower),
                endAt(searchLower + '\uf8ff')
            );
            const emailSnap = await getDocs(emailQuery);
            emailSnap.forEach(docSnap => {
                const user = docSnap.data();
                if (user.uid !== currentUser.uid) {
                    usersMap.set(user.uid, user);
                }
            });

        } else {
            // Tanpa pencarian → ambil semua user kecuali yang login
            const allUsersQuery = query(
                collection(db, 'users'),
                orderBy('displayNameLower'),
                limit(20)
            );
            const allSnap = await getDocs(allUsersQuery);
            allSnap.forEach(docSnap => {
                const user = docSnap.data();
                if (user.uid !== currentUser.uid) {
                    usersMap.set(user.uid, user);
                }
            });
        }

        const users = Array.from(usersMap.values());

        if (users.length === 0) {
            usersListEl.innerHTML = `<div class="no-users-found"><p>Tidak ada pengguna ditemukan</p></div>`;
            return;
        }

        // Ambil daftar following user saat ini
        const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
        const followingList = currentUserDoc.data()?.following || [];

        // Render daftar pengguna
        usersListEl.innerHTML = '';
        users.forEach(user => {
            const isFollowing = followingList.includes(user.uid);
            const userElement = createUserElement(user, isFollowing);
            usersListEl.appendChild(userElement);
        });

    } catch (error) {
        console.error("Error loading users:", error);
        usersListEl.innerHTML = `<div class="error-message"><p>Gagal memuat daftar pengguna</p></div>`;
    }
}
